# ZD 2D Gunfight Game - 完整项目文档

> 一个完全由AI生成的2D多人射击游戏，使用Python和Pygame开发

---

## 📋 目录

1. [项目概述](#项目概述)
2. [游戏特色](#游戏特色)
3. [系统要求](#系统要求)
4. [安装与运行](#安装与运行)
5. [游戏操作指南](#游戏操作指南)
6. [多人游戏](#多人游戏)
7. [团队系统](#团队系统) ⭐新增
8. [AI玩家系统](#ai玩家系统) ⭐新增
9. [增强版AI系统](#增强版ai系统) ⭐新增
10. [管理员命令](#管理员命令)
9. [打包发布](#打包发布)
10. [Ubuntu支持](#ubuntu支持)
11. [字体系统](#字体系统)
12. [聊天系统](#聊天系统)
13. [故障排除](#故障排除)
14. [开发信息](#开发信息)
15. [许可证](#许可证)

---

## 项目概述

ZD 2D Gunfight是一款基于Python和Pygame开发的多人射击游戏，支持局域网联机对战。游戏采用俯视角视角，提供双武器系统、真实瞄准机制和多房间地图设计。

### 技术栈
- **语言**: Python 3.7+
- **游戏引擎**: Pygame 2.0+
- **网络**: UDP Socket
- **打包工具**: PyInstaller / Nuitka / cx_Freeze

### 项目结构
```
zd-2d-gunfight/
├── main.py              # 游戏主循环和Game类（已重构）
├── player.py            # 玩家类（完整功能）
├── ai_player.py         # AI玩家系统 ⭐
├── ai_player_enhanced.py # 增强版AI玩家系统 ⭐新增
├── ai_behavior_tree.py  # AI行为树系统 ⭐新增
├── ai_personality.py    # AI个性化系统 ⭐新增
├── team.py              # 团队系统模块 ⭐新增
├── map.py               # 地图和门系统（完整功能）
├── weapons.py           # 武器系统（MeleeWeapon, Bullet, Ray）
├── network.py           # 网络管理（NetworkManager, ChatMessage）
├── utils.py             # 工具函数模块 ⭐新增
├── ui.py                # UI渲染模块 ⭐新增
├── constants.py         # 游戏常量
├── README.md            # 主文档（包含AI使用说明）
├── README_Ubuntu.md     # Ubuntu支持文档
├── Ubuntu使用说明.md    # Ubuntu快速指南
├── 字体修复说明.md      # 字体兼容性说明
└── build.py             # 跨平台Nuitka打包脚本
```

### 模块说明

#### 核心模块
- **main.py**: 游戏入口和主循环，包含Game类，负责游戏状态管理和主循环控制
- **player.py**: 完整的玩家类，包含移动、射击、受伤、复活等所有玩家相关功能
- **ai_player.py**: AI玩家系统，提供智能对手功能
- **map.py**: 地图生成和管理，包含九宫格房间系统和门的交互逻辑
- **weapons.py**: 武器系统，包含近战武器(MeleeWeapon)、子弹(Bullet)和射线(Ray)类
- **network.py**: 网络通信管理，包含NetworkManager和ChatMessage类

#### 工具模块 ⭐重构新增
- **utils.py**: 通用工具函数库
  - 角度计算: `normalize_angle()`, `angle_difference()`
  - 视野检测: `is_in_field_of_view()`, `is_visible()`, `has_line_of_sight()`
  - 碰撞检测: `line_intersects_rect()`, `line_intersects_line()`, `is_in_melee_range()`
  - 视觉效果: `create_vision_fan_points()`

- **ui.py**: UI渲染函数库
  - 字体管理: `load_fonts()`, `get_fonts()`
  - 界面绘制: `draw_menu()`, `draw_hud()`, `draw_chat()`

#### 配置模块
- **constants.py**: 游戏常量和配置参数

---

## 游戏特色

### 核心玩法

- **双武器系统**: 支持枪械和近战武器切换
- **真实瞄准机制**: 右键瞄准，视野动态变化（120°→30°）
- **多人对战**: 支持局域网多人游戏，最多10名玩家
- **房间系统**: 3x3多房间地图设计，带自动门系统
- **实时物理**: 精确的子弹轨迹和碰撞检测
- **视野系统**: 基于角度的可见性判断，增加战术性
- **聊天系统**: 实时聊天，支持滚动查看历史记录

### 最新更新 (v3.0)

#### 团队系统 ⭐新增
- **团队创建与管理**: 支持创建、加入、离开团队
- **队友识别**: 队友免疫伤害，共享视野
- **团队聊天**: 支持队内聊天和全局聊天切换
- **团队命令**: 使用`.createteam`、`.jointeam`、`.leaveteam`等命令
- **AI团队配合**: AI可以加入团队，与玩家或其他AI配合

#### 增强版AI系统 ⭐新增
- **行为树系统**: 模块化的AI决策系统
- **个性化特征**: 6种不同性格的AI（激进、防御、战术、潜行、团队、随机）
- **团队配合**: AI可以识别队友并进行团队协作
- **高级战术**: 侧翼攻击、伏击、掩护、协同攻击等
- **智能路径规划**: A*算法实现最优路径

#### AI玩家系统 ⭐基础版
- **智能AI对手**: 支持添加AI玩家进行对战
- **三种难度**: Easy（简单）、Normal（普通）、Hard（困难）
- **智能行为**: 自动巡逻、追击、攻击、撤退
- **聊天命令控制**: 使用`.addai`、`.removeai`、`.listai`命令
- **自动复活**: AI死亡后3秒自动复活
- **智能避障**: AI会自动避开墙壁和障碍物
- **动态难度**: 不同难度AI有不同的反应速度和射击精度

#### 参数优化版
- **增强子弹速度**: 从500提升至800，射击更爽快
- **提升移动速度**: 从200提升至350，操作更流畅
- **扩展瞄准距离**: 从150增加至400，视野更远
- **优化鼠标灵敏度**: 从0.3提升至0.6，瞄准更精准

#### 聊天系统增强
- **消息永久保留**: 聊天记录不再自动消失
- **可滚动显示**: 使用上下方向键查看历史消息
- **多行支持**: 完美支持换行显示（如.help命令输出）
- **智能裁剪**: 超出显示区域的消息自动裁剪

#### 字体兼容性修复
- **跨平台支持**: 智能检测操作系统，选择最佳字体
- **Ubuntu优化**: 优先使用Noto Sans CJK SC等原生字体
- **字体验证**: 严格验证中文渲染能力
- **详细日志**: 提供清晰的字体加载信息

---

## 系统要求

### Windows
- Windows 10/11
- Python 3.7+ (开发环境)
- 存储空间: 120-240MB (打包后)

### Ubuntu/Linux
- Ubuntu 18.04+ (推荐20.04+)
- Python 3.6+
- 中文字体支持
- 存储空间: 500MB+

### macOS
- macOS 10.14+
- Python 3.7+
- 存储空间: 200MB+

---

## 安装与运行

### 方法1: 直接运行源码

#### Windows
```bash
# 安装依赖
python -m pip install --upgrade pip
pip install -r requirements.txt

# 运行游戏
python main.py
```

#### Ubuntu/Linux
```bash
# 安装依赖
python3 -m pip install --upgrade pip
pip3 install -r requirements.txt

# 安装中文字体（推荐）
sudo apt install fonts-noto-cjk

# 运行游戏
python3 main.py
```

### 方法2: 运行打包版本

下载对应平台的可执行文件，双击运行即可。

---

## 游戏操作指南

### 基础控制


| 操作 | 按键 | 说明 |
|------|------|------|
| 移动 | W/A/S/D | 上/左/下/右移动 |
| 瞄准 | 鼠标移动 | 控制瞄准方向 |
| 精准瞄准 | 右键按住 | 视野缩小至30°，提高精度 |
| 射击 | 左键 | 发射子弹（枪械）或攻击（近战） |
| 切换武器 | 数字键3 | 在枪械和近战武器间切换 |
| 装填弹药 | R键 | 重新装填弹药（2秒） |
| 开关门 | E键 | 手动控制门的开关 |
| 聊天 | Y键 | 打开聊天输入框 |
| 滚动消息 | ↑/↓键 | 查看聊天历史记录 |
| 调试模式 | F3键 | 切换调试信息显示 |
| 视角显示 | F4键 | 切换视野扇形显示 |
| 退出 | ESC键 | 退出游戏或关闭聊天 |

### 武器系统详解

#### 枪械武器
- **弹药容量**: 30发
- **装填时间**: 2秒
- **射击模式**: 半自动（点射）
- **有效射程**: 800像素
- **伤害**: 标准伤害
- **适用场景**: 中远距离战斗

#### 近战武器
- **攻击范围**: 扇形区域（60°角度，100像素范围）
- **攻击速度**: 快速连击
- **伤害类型**: 范围伤害
- **冷却时间**: 0.5秒
- **适用场景**: 近距离高伤害输出

### 瞄准系统

#### 正常模式
- **视野角度**: 120°广角
- **视野距离**: 标准距离
- **适用场景**: 观察周围环境，移动战斗

#### 瞄准模式（按住右键）
- **视野角度**: 30°精准视野
- **视野距离**: 400像素（扩展）
- **射击精度**: 提高
- **适用场景**: 远程精确射击

### 房间与门系统

#### 自动门
- 靠近门时自动开启
- 离开后自动关闭
- 开启动画流畅

#### 手动控制
- 按E键手动开关门
- 可用于战术布置
- 关闭的门阻挡视线和子弹

---

## 团队系统

### 功能介绍

团队系统允许玩家创建或加入团队，与队友协同作战。团队成员之间可以共享视野、免疫伤害，并使用队内聊天进行沟通。

### 快速开始

#### 1. 创建团队
按 **Y** 键打开聊天框，输入：
```
.createteam [团队名称]
```
示例：
```
.createteam 精英小队
.createteam          # 使用默认名称
```

#### 2. 加入团队
查看团队列表：
```
.listteams
```
加入指定团队：
```
.jointeam <团队ID>
```
示例：
```
.jointeam 1
```

#### 3. 离开团队
```
.leaveteam
```

#### 4. 查看团队信息
```
.team
或
.teaminfo
```

### 团队命令详解

| 命令 | 说明 | 示例 |
|------|------|------|
| `.createteam [名称]` | 创建团队 | `.createteam 精英小队` |
| `.jointeam <ID>` | 加入团队 | `.jointeam 1` |
| `.leaveteam` | 离开团队 | `.leaveteam` |
| `.team` / `.teaminfo` | 查看团队信息 | `.team` |
| `.listteams` | 列出所有团队 | `.listteams` |
| `.invite <玩家ID>` | 邀请玩家加入当前团队 | `.invite 2` |
| `.teamchat` / `.tc` | 切换到队内聊天 | `.teamchat` |
| `.all` / `.global` | 切换到全局聊天 | `.all` |

### 团队功能特性

#### 队友免疫伤害
- 队友之间无法互相造成伤害
- 适用于子弹和近战攻击
- 自动检测团队关系

#### 共享视野
- 可以看到队友的视野范围
- 视野范围以不同颜色显示
- 增强团队协作能力

#### 团队聊天
- 队内聊天：只有队友可见（使用`.teamchat`或`.tc`）
- 全局聊天：所有玩家可见（使用`.all`或`.global`）
- 默认模式：全局聊天

#### AI团队配合
- AI可以加入团队
- AI会自动识别队友
- AI会进行团队协作（支援、掩护、协同攻击）

### 使用示例

#### 创建团队并邀请队友
```
1. 玩家A: .createteam 精英小队
   系统: 已创建团队"精英小队" (ID: 1)

2. 玩家B: .listteams
   系统: 团队列表:
         ID:1 - 精英小队 (成员: 1人)

3. 玩家A: .invite 2
   系统: 已向玩家(2)发送团队邀请

4. 玩家B: .jointeam 1      # 或在收到邀请后加入
   系统: 已加入团队"精英小队"

5. 玩家A: .team
   系统: 团队信息:
         名称: 精英小队
         成员: 玩家A, 玩家B
```

#### 团队聊天
```
1. 切换到队内聊天: .teamchat
   系统: 已切换到队内聊天模式

2. 发送队内消息: 准备进攻！
   （只有队友能看到）

3. 切换到全局聊天: .all
   系统: 已切换到全局聊天模式

4. 发送全局消息: 游戏开始！
   （所有玩家都能看到）
```

#### AI加入团队
```
1. 创建团队: .createteam
2. 添加AI: .addai normal team
   （AI会自动加入最近的团队或创建新团队）
3. AI会与玩家配合，执行团队战术
```

### 注意事项

1. **最大团队人数**: 每个团队最多5人
2. **团队限制**: 每个玩家只能加入一个团队
3. **团队解散**: 当所有成员离开时，团队自动解散
4. **AI团队**: AI可以加入团队，也可以创建自己的团队
5. **团队同步**: 团队信息会实时同步到所有客户端

---

## 多人游戏

### 服务器设置

#### 创建服务器
1. 启动游戏，选择"创建服务器"
2. 输入服务器名称（可选）
3. 输入玩家名称（可选，默认随机生成）
4. 点击"开始游戏"
5. 记录显示的IP地址和端口

#### 服务器信息
- **默认端口**: 5555 (UDP)
- **最大玩家数**: 10人
- **网络类型**: 局域网
- **同步频率**: 50ms

### 客户端连接

#### 自动扫描
1. 选择"加入服务器"
2. 等待自动扫描完成
3. 从列表中选择服务器
4. 输入玩家名称
5. 点击"连接"

#### 手动连接
1. 选择"加入服务器"
2. 点击"手动输入IP"
3. 输入服务器IP地址
4. 输入玩家名称
5. 点击"连接"

### 网络配置

#### 防火墙设置（Windows）
```powershell
# 允许UDP 5555端口
netsh advfirewall firewall add rule name="ZD 2D Gunfight" dir=in action=allow protocol=UDP localport=5555
```

#### 防火墙设置（Ubuntu）
```bash
# 允许UDP 5555端口
sudo ufw allow 5555/udp
```

---

## AI玩家系统

### 功能介绍

AI玩家系统允许你添加智能AI对手进行单人或多人对战。AI会自动巡逻、追击敌人、进行攻击和战术撤退。

### 快速开始

#### 1. 创建服务器
只有服务器主机可以添加AI玩家。

#### 2. 添加AI
按 **Y** 键打开聊天框，输入：
```
.addai
```
或指定难度：
```
.addai easy    # 简单
.addai normal  # 普通（默认）
.addai hard    # 困难
```

#### 3. 查看AI列表
```
.listai
```

#### 4. 移除AI
```
.removeai 100      # 移除ID为100的AI
.removeai all      # 移除所有AI
```

### AI命令详解

| 命令 | 说明 | 示例 |
|------|------|------|
| `.addai [难度]` | 添加AI玩家 | `.addai hard` |
| `.removeai <ID\|all>` | 移除AI玩家 | `.removeai 100` |
| `.listai` | 列出所有AI | `.listai` |
| `.help` | 显示帮助 | `.help` |

### AI难度对比

| 难度 | 反应速度 | 射击精度 | 决策速度 | 适合场景 |
|------|----------|----------|----------|----------|
| **Easy** | 慢 (0.5-1.0秒) | 低 (15-30°偏差) | 慢 (0.8-1.2秒) | 新手练习 |
| **Normal** | 中 (0.2-0.5秒) | 中 (5-15°偏差) | 中 (0.4-0.8秒) | 日常对战 |
| **Hard** | 快 (0.1-0.2秒) | 高 (0-5°偏差) | 快 (0.2-0.4秒) | 高手挑战 |

### AI行为模式

#### 🚶 巡逻模式 (Patrol)
- AI在地图上随机巡逻
- 寻找敌人
- 没有发现敌人时的默认状态

#### 🏃 追击模式 (Chase)
- 发现敌人后追击
- 保持中等距离（150-400像素）
- 尝试接近到攻击范围

#### 🎯 攻击模式 (Attack)
- 进入射程后开火
- 保持最佳攻击距离（100-200像素）
- 生命值低于30%时会切换到撤退

#### 🛡️ 撤退模式 (Retreat)
- 生命值低于30%时触发
- 远离敌人
- 边撤退边反击

### 使用技巧

#### 单人练习
```
.addai easy
```
添加简单AI练习瞄准和走位。

#### 团队对战
```
.addai hard
.addai hard
.addai hard
```
邀请朋友一起对抗多个困难AI。

#### 混合难度
```
.addai easy
.addai normal
.addai hard
```
同时添加不同难度的AI，增加游戏趣味性。

### 注意事项

1. **仅服务端可用**: 只有服务器主机可以添加/移除AI
2. **AI ID范围**: AI玩家ID从100开始，与普通玩家ID区分
3. **自动复活**: AI死亡后3秒自动复活
4. **视线检测**: AI只能攻击视线范围内的敌人
5. **自动装填**: AI会在弹药不足时自动装填
6. **性能建议**: 建议不超过10个AI以保证游戏流畅

### 示例游戏流程

```
1. 创建服务器
2. 按 Y 打开聊天
3. 输入：.addai normal
   系统：已添加AI玩家 (难度: normal, ID: 100)
4. 输入：.addai hard
   系统：已添加AI玩家 (难度: hard, ID: 101)
5. 输入：.listai
   系统：AI玩家列表(2):
         ID:100 - AI_normal_100 (难度:normal, 生命值:100)
         ID:101 - AI_hard_101 (难度:hard, 生命值:100)
6. 开始游戏！
7. 游戏结束后输入：.removeai all
   系统：已移除所有AI玩家 (共2个)
```

### 常见问题

#### Q: 为什么我无法添加AI？
A: 只有服务器主机（创建服务器的玩家）可以添加AI。

#### Q: AI会自动复活吗？
A: 是的，AI死亡后3秒会自动复活。

#### Q: AI最多可以添加多少个？
A: 理论上没有限制，但建议不超过10个以保证游戏流畅。

#### Q: AI会使用近战武器吗？
A: 当前版本AI只使用枪械，未来版本会添加近战功能。

#### Q: 如何区分AI和真实玩家？
A: AI的名称格式为 `AI_难度_ID`，例如 `AI_hard_100`。

### AI技术实现

#### 智能路径规划 ⭐全面升级
- **A*算法**: 使用pathfinding库实现智能导航
- **动态避障**: 自动避开墙壁等固定障碍物
- **门路径优化**: 将门视为可通行，规划最优路径
- **智能门交互**: 移动过程中自动检测并开启路径上的门
- **网格化地图**: 将游戏地图转换为导航网格(20x20像素)
- **实时路径更新**: 每秒重新计算最优路径
- **战术移动**: 根据战场情况选择静步、正常或战斗速度

#### 行为系统 ⭐声音驱动
- **巡逻模式**: 静默巡逻，通过声音搜索敌人，自动开门探索
- **追击模式**: 根据声音线索追踪敌人，静步接近声源位置
- **攻击模式**: 确认视线后精确射击，避免对墙射击，侧向机动
- **撤退模式**: 静步隐蔽撤退，避免产生声音暴露位置

#### 难度系统
- **Easy**: 反应慢(0.5-1.0秒)，精度低(15-30°偏差)，适合新手练习
- **Normal**: 反应中等(0.2-0.5秒)，精度中等(5-15°偏差)，适合日常对战
- **Hard**: 反应快(0.1-0.2秒)，精度高(0-5°偏差)，适合高手挑战

#### 智能特性 ⭐革命性升级
- **综合感知系统**: 视觉+听觉双重感知，优先级智能切换
- **智能射击控制**: 检查视线，不会对着墙壁开枪
- **AI声音系统**: AI会产生脚步声、枪声、装填声，玩家可以听到
- **调试输出**: 实时显示AI的感知、决策和声音产生过程
- A*智能路径规划和动态避障
- 自动装填和弹药管理
- **智能门交互**: AI可以自动开门通过障碍
- **战术静步**: 根据威胁等级选择移动模式
- **动态速度调节**: 静步(40%速度)、正常(100%)、战斗(120%速度)
- 死亡后自动复活(3秒)

### AI战术系统 ⭐革命性升级

#### AI声音产生系统 ⭐新增
AI现在会像真实玩家一样产生各种声音：

**声音类型**:
- **脚步声**: 正常移动时产生(音量1.0)
- **静步声**: 隐蔽移动时产生(音量0.3)
- **枪声**: 射击时产生(音量1.0)
- **装填声**: 换弹时产生(音量0.8)

**声音特性**:
- **距离衰减**: 声音强度随距离衰减
- **检测范围**: 脚步声400px，枪声600px
- **实时同步**: 声音状态实时同步到所有玩家
- **调试显示**: 游戏中显示附近AI的声音状态

#### 综合感知系统 ⭐升级
AI同时使用视觉和听觉来感知敌人，更加智能和真实：

**声音类型检测**:
- **脚步声**: 正常移动(音量1.0)，静步(音量0.3)
- **枪声**: 射击时产生最大音量(1.5)
- **装填声**: 换弹时产生中等音量(0.8)

**声音感知机制**:
- **检测范围**: 200像素声音感知半径
- **距离衰减**: 声音强度随距离衰减
- **声音记忆**: 保持5秒声音记忆，追踪敌人最后位置
- **最小阈值**: 音量低于0.1时无法检测

**感知优先级系统**:
- **视觉接触**: 最高优先级，直接锁定目标
- **声音接触**: 次优先级，根据声音类型决策
- **记忆搜索**: 前往最后已知位置
- **巡逻模式**: 无威胁时的默认状态

**智能决策逻辑**:
- 看到敌人→立即锁定并攻击/追击
- 听到枪声→进入战斗状态
- 听到脚步声→谨慎接近调查
- 听到装填声→快速接近攻击
- 失去接触→搜索最后位置

#### 智能射击控制 ⭐新增
- **视线检查**: 射击前必须确认有清晰视线到目标
- **墙壁检测**: 绝不会对着墙壁或障碍物开枪
- **门遮挡检测**: 考虑关闭的门对视线的影响
- **位置调整**: 无视线时自动移动寻找更好的射击角度

#### 智能门交互 ⭐升级
- **路径规划**: 将所有门标记为可通行区域
- **动态开门**: AI在移动路径上遇到关闭的门时自动开启
- **预判开门**: 检测接下来的路径点，提前开启必要的门
- **智能通过**: 开门后继续执行原定路径，无需重新规划

#### 战术静步系统
AI会根据以下情况自动选择移动模式：

**静步模式 (40%速度)**:
- 敌人在100-250像素范围内（潜行接近）
- 多个敌人在附近（隐蔽移动）
- 生命值低于50%时撤退（隐蔽撤退）
- 正在装填弹药（减少暴露）

**战斗模式 (120%速度)**:
- 距离敌人150像素内的激烈战斗
- 需要快速机动和位置调整

**正常模式 (100%速度)**:
- 巡逻和一般移动
- 中距离追击

#### 战术决策
- **每2秒重新评估**战场情况
- **动态调整**移动策略
- **智能平衡**隐蔽性和机动性

### 快速参考

#### 基本命令
```
.addai [难度]     # 添加AI玩家
.removeai <ID>    # 移除指定AI
.removeai all     # 移除所有AI
.listai           # 查看AI列表
.help             # 显示帮助
```

#### 使用示例
```bash
# 单人练习
.addai easy

# 团队对战
.addai hard
.addai hard
.addai hard

# 混合难度
.addai easy
.addai normal
.addai hard
```

---

## 增强版AI系统

### 功能介绍

增强版AI系统使用行为树和个性化特征，提供更智能、更多样化的AI行为。AI可以识别队友、执行团队战术，并与玩家或其他AI进行配合。

### 快速开始

#### 1. 添加增强版AI
增强版AI系统已集成到游戏中，使用`.addai`命令时自动使用增强版AI：
```
.addai [难度] [性格]
```

#### 2. 支持的难度
- `easy` - 简单（反应慢，精度低）
- `normal` - 普通（默认）
- `hard` - 困难（反应快，精度高）

#### 3. 支持的性格类型
- `aggressive` - 激进型：主动攻击，不轻易撤退
- `defensive` - 防御型：优先寻找掩体，生命值低时撤退
- `tactical` - 战术型：使用侧翼、伏击等战术
- `stealthy` - 潜行型：优先使用静步，寻找伏击机会
- `team` / `team_player` - 团队型：与队友配合，避免误伤
- `random` - 随机型：行为随机

### 使用示例

#### 添加不同性格的AI
```
.addai normal aggressive    # 添加激进型AI
.addai hard tactical        # 添加战术型AI
.addai normal team          # 添加团队型AI
.addai easy random          # 添加随机性格AI
```

#### AI团队配合
```
1. 创建团队: .createteam
2. 添加团队型AI: .addai normal team
3. AI会自动加入团队，与玩家配合
4. AI会执行团队战术：支援、掩护、协同攻击
```

### AI行为树系统

#### 行为节点类型

**组合节点**:
- `SelectorNode` - 选择节点（或逻辑）
- `SequenceNode` - 序列节点（与逻辑）
- `ParallelNode` - 并行节点

**条件节点**:
- `HasEnemyInSight` - 检查是否有敌人在视线内
- `HasEnemyInSoundRange` - 检查是否有敌人在声音范围内
- `HasTeammateInDanger` - 检查是否有队友处于危险中 ⭐新增
- `HasTeammateNearby` - 检查附近是否有队友 ⭐新增
- `HasTeammateEngaging` - 检查是否有队友正在与敌人交火 ⭐新增
- `IsHealthLow` - 检查生命值是否低
- `IsAmmoLow` - 检查弹药是否不足
- `IsInDanger` - 检查是否处于危险中

**行为节点**:
- `PatrolAction` - 巡逻行为
- `ChaseAction` - 追击行为
- `AttackAction` - 攻击行为
- `RetreatAction` - 撤退行为
- `FindCoverAction` - 寻找掩体行为
- `FlankAction` - 侧翼攻击行为
- `AmbushAction` - 伏击行为
- `TeamSupportAction` - 团队支援行为 ⭐新增
- `CoordinateAttackAction` - 协同攻击行为 ⭐新增
- `CoverTeammateAction` - 掩护队友行为 ⭐新增
- `ReloadAction` - 装填行为

### AI个性化特征

#### 性格类型详解

| 性格 | 攻击性 | 防御性 | 团队合作 | 适用场景 |
|------|--------|--------|----------|----------|
| **激进型** | 90% | 20% | 30% | 主动攻击，快速战斗 |
| **防御型** | 30% | 90% | 40% | 保守防守，寻找掩体 |
| **战术型** | 60% | 50% | 60% | 使用战术，侧翼攻击 |
| **潜行型** | 40% | 60% | 30% | 静步移动，伏击敌人 |
| **团队型** | 50% | 50% | 90% | 团队配合，协同作战 |
| **随机型** | 随机 | 随机 | 随机 |  unpredictable行为 |

### AI团队合作功能

#### 团队支援
- AI会检测处于危险中的队友
- 自动移动到队友附近提供支援
- 攻击威胁队友的敌人

#### 协同攻击
- AI会检测正在与敌人交火的队友
- 自动移动到侧翼位置形成交叉火力
- 与队友一起攻击同一目标

#### 掩护队友
- AI会为附近的队友提供掩护
- 移动到队友后方，射击威胁
- 保护队友的安全

### 行为树类型

#### 激进型行为树
优先级：装填 > 支援队友 > 攻击 > 协同攻击 > 追击 > 巡逻

#### 防御型行为树
优先级：装填 > 撤退 > 寻找掩体 > 攻击 > 巡逻

#### 战术型行为树
优先级：装填 > 支援 > 协同攻击 > 侧翼 > 掩护 > 攻击 > 追击 > 巡逻

#### 潜行型行为树
优先级：装填 > 伏击 > 寻找掩体 > 攻击 > 巡逻

#### 团队型行为树 ⭐新增
优先级：装填 > 支援队友 > 协同攻击 > 掩护队友 > 攻击 > 侧翼 > 追击 > 巡逻

### 技术实现

#### 行为树系统
- 使用模块化的行为树框架
- 支持条件节点和行为节点
- 动态决策，实时调整行为

#### 团队识别
- AI自动识别队友和敌人
- 通过团队管理器验证团队关系
- 避免攻击队友

#### 路径规划
- 使用A*算法进行路径规划
- 考虑墙壁和门的阻挡
- 动态调整路径

### 性能优化

#### 建议配置
- AI数量：建议不超过10个
- 性格分布：混合使用不同性格
- 团队规模：每个团队2-5人

#### 性能提示
- 团队型AI会消耗更多CPU资源
- 大量AI时建议使用简单性格
- 可以使用`.removeai all`移除所有AI

### 常见问题

#### Q: 如何让AI加入我的团队？
A: 创建团队后，AI会自动检测并可能加入。你也可以使用`.addai normal team`添加团队型AI。

#### Q: AI会攻击队友吗？
A: 不会。增强版AI系统会自动识别队友，不会对队友造成伤害。

#### Q: 如何查看AI的性格？
A: AI的名称格式为 `AI_性格_ID`，例如 `AI_aggressive_100`。

#### Q: AI会执行团队战术吗？
A: 是的。团队型AI和加入团队的AI会自动执行团队战术，包括支援、掩护、协同攻击等。

---

## 管理员命令

管理员命令仅限服务器端使用，在聊天框中输入。

### 命令列表

#### .help
显示所有可用命令
```
.help
```

### 团队命令 ⭐新增

#### .createteam
创建团队
```
.createteam [团队名称]
```
示例: `.createteam 精英小队`

#### .jointeam
加入团队
```
.jointeam <团队ID>
```
示例: `.jointeam 1`

#### .leaveteam
离开团队
```
.leaveteam
```

#### .team / .teaminfo
查看团队信息
```
.team
```

#### .listteams
列出所有团队
```
.listteams
```

#### .invite
邀请玩家加入你所在的团队（需要你已在团队中）
```
.invite <玩家ID>
```
示例: `.invite 2`

#### .teamchat / .tc
切换到队内聊天
```
.teamchat
```

#### .all / .global
切换到全局聊天
```
.all
```

### AI命令（增强版） ⭐新增

#### .addai
添加AI玩家（支持性格参数）
```
.addai [难度] [性格]
```
示例:
- `.addai normal aggressive` - 添加激进型AI
- `.addai hard tactical` - 添加战术型AI
- `.addai normal team` - 添加团队型AI

#### .list / .players
显示在线玩家列表
```
.list
```

#### .kick
踢出指定玩家
```
.kick <玩家ID> [原因]
```
示例: `.kick 2 违规行为`

#### .broadcast
广播系统消息
```
.broadcast <消息内容>
```
示例: `.broadcast 游戏即将重启`

#### .heal
治疗玩家
```
.heal <玩家ID|all> [生命值]
```
示例: 
- `.heal 2 100` - 将玩家2的生命值设为100
- `.heal all` - 治疗所有玩家至满血

#### .respawn
复活死亡玩家
```
.respawn <玩家ID|all>
```
示例:
- `.respawn 2` - 复活玩家2
- `.respawn all` - 复活所有死亡玩家

#### .tp
传送玩家到指定坐标
```
.tp <玩家ID|all> <x> <y>
```
示例: `.tp 2 500 500` - 将玩家2传送到(500, 500)

#### .kill
自杀（所有玩家可用）
```
.kill
```

#### .weapon
切换武器类型
```
.weapon
```

#### .ammo
补充弹药
```
.ammo
```

#### .speed
临时提高移动速度
```
.speed [倍率] [持续时间]
```
示例: `.speed 2 10` - 2倍速度持续10秒

---

## 打包发布

项目现已统一使用 `build.py`（Nuitka）进行跨平台打包。脚本会根据当前操作系统自动选择输出目录、可执行文件名，并启用对 `pygame` 与 `pathfinding` 等外部库的完整打包支持。

### 依赖准备

```bash
pip install --upgrade nuitka ordered-set
```

> 提示：首次运行 `build.py` 时如果检测到未安装 Nuitka，会自动执行 `pip install nuitka`。

### 基本用法

```bash
# Windows / macOS
python build.py --clean --onefile

# Linux
python3 build.py --clean
```

- `--clean`：删除旧的 `dist/<os>/` 输出目录后再构建。
- `--onefile`：生成单文件可执行程序（Windows/macOS/Linux均可用）。
- `--disable-console`：仅在 Windows 上隐藏控制台窗口。
- `--jobs N`：设置并行编译进程数，默认使用 CPU 核心数 - 1。
- `--dry-run`：只打印即将执行的 Nuitka 命令，便于调试。
- `--extra-arg ...`：将附加参数直接传递给 Nuitka，可重复使用多次。
- `--mode {auto,windows,linux,mac}`：切换脚本的配置档案。仅影响输出目录与命名，仍需在目标操作系统上完成编译。

### 输出结构

- Windows：`dist/windows/ZD-2D-Gunfight.exe`
- Linux：`dist/linux/ZD-2D-Gunfight`
- macOS：`dist/darwin/ZD-2D-Gunfight.app`

同一台机器可多次运行脚本，所有构建产物会按系统维度分别存放，互不覆盖。

### 常见示例

```bash
# Windows，一键打包并隐藏控制台
python build.py --clean --onefile --disable-console

# Linux，生成多文件目录结构，保留控制台
python3 build.py --clean

# macOS，生成 .app Bundle
python3 build.py --clean --onefile

# 仅查看命令行而不真正编译
python build.py --dry-run --onefile
```

构建完成后，`dist/<os>/` 下会包含完整的可执行文件和依赖库，可直接压缩后分发给同平台玩家。

---

## Ubuntu支持

### 快速开始

#### 1. 安装依赖
```bash
sudo apt update
sudo apt install python3 python3-pip python3-dev build-essential
pip3 install pygame nuitka
```

#### 2. 安装中文字体
```bash
# 自动安装
python3 install_ubuntu_fonts.py

# 或手动安装
sudo apt install fonts-noto-cjk fonts-wqy-microhei
fc-cache -fv
```

#### 3. 验证字体修复
```bash
python3 verify_font_fix.py
```

#### 4. 运行游戏
```bash
python3 main.py
```

### 支持的Ubuntu版本
- ✅ Ubuntu 20.04 LTS (Focal Fossa)
- ✅ Ubuntu 22.04 LTS (Jammy Jellyfish)
- ✅ Ubuntu 23.04 (Lunar Lobster)
- ✅ Ubuntu 23.10 (Mantic Minotaur)
- ⚠️ Ubuntu 18.04 LTS (需要Python 3.8+)

---

## 字体系统

### 字体兼容性修复

#### 问题描述
在Ubuntu上，`pygame.font.SysFont('Microsoft YaHei')`会错误地返回字体对象，但实际使用fallback字体，导致显示效果差。

#### 修复方案
1. **智能操作系统检测**: 根据系统选择合适的字体列表
2. **严格字体验证**: 验证中文渲染能力，而不仅仅检查字体对象
3. **详细日志输出**: 提供清晰的字体加载信息

### 支持的字体

#### Ubuntu/Linux（按优先级）
1. **Noto Sans CJK SC** - Google Noto字体（推荐）
2. **Noto Sans CJK TC** - 繁体中文支持
3. **WenQuanYi Micro Hei** - 文泉驿微米黑
4. **WenQuanYi Zen Hei** - 文泉驿正黑
5. **Droid Sans Fallback** - Android字体
6. **AR PL UMing CN** - 文鼎明体
7. **AR PL UKai CN** - 文鼎楷体

#### Windows
1. **Microsoft YaHei** - 微软雅黑
2. **SimHei** - 黑体
3. **SimSun** - 宋体
4. **Arial Unicode MS**

#### macOS
1. **PingFang SC** - 苹方
2. **Hiragino Sans GB** - 冬青黑体
3. **STHeiti** - 华文黑体

### 字体安装

#### Ubuntu最小安装（推荐）
```bash
sudo apt install fonts-noto-cjk
```

#### Ubuntu完整安装
```bash
sudo apt install fonts-noto-cjk fonts-wqy-microhei fonts-wqy-zenhei
```

#### 验证字体
```bash
# 列出已安装的中文字体
fc-list :lang=zh

# 测试字体渲染
python3 test_ubuntu_fonts.py
```

---

## 聊天系统

### 功能特性

#### 基础功能
- **实时聊天**: 所有玩家可见
- **玩家标识**: 显示玩家名称和ID
- **系统消息**: 服务器通知和命令反馈

#### 高级功能
- **消息永久保留**: 聊天记录不会自动消失
- **可滚动显示**: 使用方向键查看历史
- **多行支持**: 完美支持换行文本
- **智能裁剪**: 超出区域自动裁剪

### 使用方法

#### 发送消息
1. 按Y键打开聊天框
2. 输入消息内容
3. 按Enter发送
4. 按ESC取消

#### 查看历史
- 按↑键: 向上滚动，查看更早的消息
- 按↓键: 向下滚动，查看更新的消息
- 无需打开聊天框即可滚动

#### 显示区域
- **顶部限制**: y=250
- **底部限制**: y=540
- **可见高度**: 290像素
- **滚动提示**: 显示是否有更多消息

### 命令系统

所有以`.`开头的消息会被识别为命令，详见[管理员命令](#管理员命令)章节。

---

## 故障排除

### 连接问题

#### 无法连接到服务器
**可能原因**:
- 服务器未启动
- 不在同一局域网
- 防火墙阻止
- IP地址错误

**解决方法**:
1. 确认服务器已启动并显示IP
2. 检查网络连接（ping测试）
3. 配置防火墙允许UDP 5555端口
4. 尝试手动输入IP地址

#### 扫描不到服务器
**可能原因**:
- 网络设备阻止UDP广播
- 不在同一网段
- 防火墙阻止扫描

**解决方法**:
1. 使用"刷新服务器列表"
2. 手动输入服务器IP
3. 检查路由器设置

### 字体问题

#### Ubuntu中文显示异常
**解决方法**:
```bash
# 1. 运行字体测试
python3 test_ubuntu_fonts.py

# 2. 安装推荐字体
sudo apt install fonts-noto-cjk

# 3. 刷新字体缓存
fc-cache -fv

# 4. 验证修复
python3 verify_font_fix.py
```

#### Windows中文显示方块
**解决方法**:
1. 确保系统已安装中文字体
2. 重启游戏
3. 检查系统语言设置

### 性能问题

#### 游戏卡顿
**优化方法**:
1. 关闭其他占用资源的程序
2. 使用打包版本而非Python脚本
3. 降低游戏分辨率（修改constants.py）
4. 更新显卡驱动

#### 网络延迟高
**优化方法**:
1. 使用有线网络连接
2. 减少同时连接的玩家数
3. 确保服务器网络稳定
4. 避免网络繁忙时段

### 打包问题

#### Nuitka打包失败
**解决方法**:
```bash
# Windows
pip install --upgrade nuitka
pip install ordered-set

# Ubuntu
sudo apt install gcc g++ python3-dev
pip3 install --upgrade nuitka
```

#### PyInstaller打包失败
**解决方法**:
```bash
# 清理缓存
rmdir /s /q build dist  # Windows
rm -rf build dist       # Linux

# 重新安装
pip uninstall pyinstaller
pip install pyinstaller
```

---

## 开发信息

### 项目文件说明

#### 核心文件
- `main.py` - 游戏主循环和Game类（已重构，仅包含游戏主逻辑）
- `player.py` - 完整的玩家类，处理移动、射击、生命值、武器切换等
- `ai_player.py` - AI玩家系统，智能对手逻辑 ⭐
- `map.py` - 完整的地图系统，包含九宫格房间和门的管理
- `weapons.py` - 武器系统，包含MeleeWeapon、Bullet、Ray类
- `network.py` - 网络管理，包含NetworkManager和ChatMessage类
- `utils.py` - 工具函数模块，提供角度计算、视野检测、碰撞检测等 ⭐新增
- `ui.py` - UI渲染模块，提供字体管理和界面绘制函数 ⭐新增
- `constants.py` - 游戏常量配置

#### 代码重构 ⭐已完成
项目已完成大规模代码重构，将原本5000+行的main.py拆分为模块化结构：
- **模块化设计**: 代码按功能分离到独立模块
- **消除重复**: 合并了重复的类定义
- **职责清晰**: 每个模块有明确的职责
- **易于维护**: 代码结构清晰，便于后续开发和维护

#### 打包脚本
- `build.py` - Nuitka统一打包脚本（自动识别平台和依赖）
- `setup_cxfreeze.py` - cx_Freeze打包配置

#### 工具脚本
- `install_ubuntu_fonts.py` - Ubuntu字体安装助手
- `test_ubuntu_fonts.py` - 字体测试工具
- `verify_font_fix.py` - 字体修复验证
- `install_packaging_tools.py` - 打包工具安装

### 技术架构

#### 游戏循环
```python
while running:
    # 1. 处理事件
    handle_events()
    
    # 2. 更新游戏状态
    update_game_state()
    
    # 3. 网络同步
    sync_network()
    
    # 4. 渲染画面
    render()
    
    # 5. 控制帧率
    clock.tick(60)
```

#### 网络架构
- **协议**: UDP
- **模式**: 客户端-服务器
- **同步**: 状态同步（50ms间隔）
- **消息格式**: JSON

#### 视野系统
- **算法**: 基于角度的扇形视野
- **检测**: 射线投射法
- **优化**: 视野裁剪，只渲染可见对象

### 游戏常量配置

主要常量定义在`constants.py`中：

```python
# 屏幕设置
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 600

# 玩家设置
PLAYER_SPEED = 350
PLAYER_RADIUS = 20
PLAYER_HEALTH = 100

# 武器设置
BULLET_SPEED = 800
BULLET_DAMAGE = 10
MAGAZINE_SIZE = 30
RELOAD_TIME = 2.0

# 视野设置
VISION_RANGE = 400
NORMAL_FOV = 120
AIMING_FOV = 30

# 网络设置
SERVER_PORT = 5555
BUFFER_SIZE = 4096
```

### 贡献指南

欢迎提交Issue和Pull Request！

#### 提交Issue
- 描述问题或建议
- 提供复现步骤
- 附上系统信息和错误日志

#### 提交PR
- Fork项目
- 创建功能分支
- 提交清晰的commit信息
- 确保代码通过测试
- 提交Pull Request

---

## 许可证

本项目采用 **GNU General Public License v3.0** 许可证。

### 主要条款
- ✅ 可以自由使用、修改和分发
- ✅ 可以用于商业用途
- ⚠️ 修改后的代码必须开源
- ⚠️ 必须保留原作者版权信息
- ⚠️ 必须使用相同的GPL v3许可证

详见 [LICENSE](LICENSE) 文件。

---

## 联系方式

- **项目地址**: https://github.com/123456Zhe/zd-2d-gunfight
- **问题反馈**: 通过GitHub Issues提交

---


**Enjoy the game! 🎮**
